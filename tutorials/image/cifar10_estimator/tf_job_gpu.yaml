# Copyright 2017 Google Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: "kubeflow.org/v1alpha1"
kind: "TFJob"
metadata:
  name: cifar10-estimator-8gpu
  namespace: default
spec:
  # Setup a Tensorboard instance.
  # To access, run kubectl proxy &
  # RUNTIME_ID=$(kubectl get tfjobs cifar10-estimator-8gpu -o yaml | grep -i runtime | awk '{print $2}') 
  # google-chrome http://localhost:8001/api/v1/proxy/namespaces/default/services/cifar10-estimator-8gpu-tensorboard-${RUNTIME_ID}:80/
  tensorboard:
    logDir: gs://cifar10-model-data
  replicaSpecs:
  # Cluster Config: 3 workers (4 GPUs each), 1 PS-servers with a master
  tensorboard:
    logDir: gs:/cifar10-model-data
  replicaSpecs:
  - replicas: 2
    tfReplicaType: WORKER
    template:
      spec:
        containers:
        - args:
          - python
          - cifar10_main.py
          - --data-dir=gs://monteirom-distributed-experiment/cifar10-tfrecords
          - --job-dir=gs://cifar10-model-data
          - --num-gpus=4
          - --train-steps=10000
          - --sync
          - --train-batch-size=256
          - --learning-rate=0.8
          - --eval-batch-size=200
          image: gcr.io/vishnuk-cloud/tf-models-gpu@sha256:a3c46a5d23c132bbbd99bf818952d504545bb14b4d02fa626c0b06039db8af48
          name: tensorflow
          resources:
            limits:
              nvidia.com/gpu: 4
          workingDir: /tensorflow_models/tutorials/image/cifar10_estimator
        restartPolicy: OnFailure
  - replicas: 1
    tfReplicaType: MASTER
    template:
      spec:
        containers:
        - args:
          - python
          - cifar10_main.py
          - --data-dir=gs://monteirom-distributed-experiment/cifar10-tfrecords
          - --job-dir=gs://cifar10-model-data
          - --num-gpus=4
          - --train-steps=10000
          - --sync
          - --train-batch-size=256
          - --learning-rate=0.8
          - --eval-batch-size=200
          image: gcr.io/vishnuk-cloud/tf-models-gpu@sha256:a3c46a5d23c132bbbd99bf818952d504545bb14b4d02fa626c0b06039db8af48
          name: tensorflow
          workingDir: /tensorflow_models/tutorials/image/cifar10_estimator
          resources:
            limits:
              nvidia.com/gpu: 4
        restartPolicy: OnFailure
  - replicas: 1
    tfReplicaType: PS
    template:
      spec:
        containers:
        - args:
          - python
          - cifar10_main.py
          - --data-dir=gs://monteirom-distributed-experiment/cifar10-tfrecords
          - --job-dir=gs://tensorflow-experimental/cifar10-model-data
          image: gcr.io/vishnuk-cloud/tf-models-cpu@sha256:8ccc6a28a97fdfa1c28b28c733c5979b22b35a8061a0852e78b5b92c680dbfa7
          name: tensorflow
          workingDir: /tensorflow_models/tutorials/image/cifar10_estimator
        restartPolicy: OnFailure
